<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å¥èº«é£²é£Ÿç®¡ç† Web</title>

<style>
body {
  font-family: Arial;
  background:#f6f7f8;
}

.container {
  max-width:1100px;
  margin:auto;
}

.card {
  background:white;
  padding:25px;
  border-radius:12px;
  margin:15px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
}

.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

button {
  padding:12px;
  width:100%;
  background:#18a874;
  color:white;
  border:none;
  border-radius:8px;
  font-size:16px;
  cursor:pointer;
}

input,select {
  width:100%;
  padding:10px;
  margin:6px 0 12px;
  border-radius:6px;
  border:1px solid #ccc;
}

hr { margin:20px 0; }

/* ===== é€²åº¦æ¢ ===== */

.bar {
  width:100%;
  height:18px;
  background:#e5e7eb;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:12px;
}

.fill {
  height:100%;
  border-radius:10px;
}

.red { background:#ef4444; }
.green { background:#22c55e; }
.blue { background:#3b82f6; }
.yellow { background:#facc15; }

.label {
  font-weight:bold;
  margin-top:8px;
}
</style>
<link rel="manifest" href="/static/manifest.json">
<meta name="theme-color" content="#18a874">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">

</head>

<body>

<div class="container">

<h1 style="text-align:center">ğŸ‹ï¸ å¥èº«é£²é£Ÿç®¡ç† Web ç‰ˆ</h1>

<div class="grid">

<!-- ================= å·¦å´ ================= -->
<div class="card">

<form method="post">

{% if error %}
<div class="error-box">
    âŒ {{ error }}
</div>
{% endif %}

<label>æ—¥æœŸ</label>
<input type="date" name="date" value="{{ today }}" onchange="location.href='/?date=' + this.value">

<label>é¤åˆ¥</label>
<select name="meal">
  <option>æ—©é¤</option>
  <option>åˆé¤</option>
  <option>æ™šé¤</option>
  <option>é»å¿ƒ</option>
</select>

<label>é£Ÿç‰©ï¼ˆå…‹æ•¸è¨ˆç®—ï¼‰</label>
<input list="foods" name="food" placeholder="ä¾‹å¦‚ï¼šé›èƒ¸è‚‰">
<datalist id="foods">
{% for f in foods %}
<option value="{{f}}">
{% endfor %}
</datalist>

<label>å…‹æ•¸</label>
<input name="grams" value="100">

<button>â• æ–°å¢ä¸€èˆ¬é£Ÿç‰©</button>

</form>

<hr>

<h3>ğŸ± è‡ªè¨‚é¤é»</h3>

<label>é¤å»³</label>
<select id="brand" onchange="updateMeals()">
{% for b in brands %}
<option value="{{b}}">{{b}}</option>
{% endfor %}
</select>

<label>é¤é»</label>
<select id="meal"></select>

<label>ä»½é‡æ¯”ä¾‹</label>
<input id="ratio" value="1">

<button onclick="addCustom()">â• æ–°å¢è‡ªè¨‚é¤é»</button>



</div>

<!-- ================= å³å´ ================= -->
<div class="card">

<h3>ğŸ“‹ ä»Šæ—¥é£²é£Ÿæ¸…å–®</h3>

<ul style="padding-left:20px">
{% for i in logs %}
<li style="margin-bottom:8px">

  {{ loop.index }}.
  {{ i.meal }} -
  {% if i.brand %}
    ã€{{ i.brand }}ã€‘
  {% endif %}
  {{ i.food }}

  {% if i.grams %}
    ({{ i.grams }} g)
  {% else %}
    ({{ i.kcal|round }} kcal)
  {% endif %}

  <button
    style="margin-left:10px;
           padding:4px 8px;
           background:#ef4444;
           color:white;
           border:none;
           border-radius:6px;
           cursor:pointer"
    onclick="deleteLog({{ loop.index0 }})">
    âŒ
  </button>

</li>
{% endfor %}
</ul>

<hr>

<h3>ğŸ“Š ä»Šæ—¥ç¸½ç‡Ÿé¤Š</h3>

<div class="label">
ğŸ”¥ ç†±é‡ {{ total.kcal|round(1) }} / 2650 kcal
</div>
<div class="bar">
  <div class="fill red"
       style="width: {{ (total.kcal/2650*100)|round(1) }}%">
  </div>
</div>

<div class="label">
ğŸ’ª è›‹ç™½è³ª {{ total.protein|round(1) }} / 130 g
</div>
<div class="bar">
  <div class="fill green"
       style="width: {{ (total.protein/130*100)|round(1) }}%">
  </div>
</div>

<div class="label">
ğŸš ç¢³æ°´ {{ total.carbs|round(1) }} / 350 g
</div>
<div class="bar">
  <div class="fill blue"
       style="width: {{ (total.carbs/350*100)|round(1) }}%">
  </div>
</div>

<div class="label">
ğŸ¥‘ è„‚è‚ª {{ total.fat|round(1) }} / 70 g
</div>
<div class="bar">
  <div class="fill yellow"
       style="width: {{ (total.fat/70*100)|round(1) }}%">
  </div>
</div>

</div>
</div>
</div>

<script>
const customs = {{ customs | tojson }};

function updateMeals(){
  const b = document.getElementById("brand").value;
  const sel = document.getElementById("meal");
  sel.innerHTML = "";
  Object.keys(customs[b]).forEach(m=>{
    const o=document.createElement("option");
    o.value=m; o.textContent=m;
    sel.appendChild(o);
  })
}
updateMeals();

function addCustom(){
  fetch("/add_custom",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      brand: document.getElementById("brand").value,
      meal: document.getElementById("meal").value,
      ratio: document.getElementById("ratio").value,
      date: "{{ today }}",
      meal_type: document.querySelector("select[name='meal']").value
    })
  }).then(()=>location.reload());
}

function deleteLog(index){
  if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ")) return;

  fetch("/delete", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      date: "{{ today }}",
      index: index
    })
  }).then(()=>location.reload());
}

</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/static/service-worker.js");
}
</script>


</body>
</html>
